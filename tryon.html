<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>AI Virtual Try-On</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Upload your photo and virtually try on clothing with AI-powered style recommendations." />
    <link rel="stylesheet" href="style/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="js/theme.js"></script>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <button id="theme-toggle-btn" class="theme-toggle-btn">üåô</button>
        <ul class="nav-links">
            <li><a href="#" class="active">Home</a></li>
            <li><a href="wardrobe.html">Wardrobe</a></li>
            <li><a href="profile.html">Profile</a></li>
        </ul>
        <div class="logo">AI Try-On</div>
        <div class="user-menu" id="user-info-nav">
            <!-- User info will be injected here -->
            <button onclick="logout()" class="nav-btn">Logout</button>
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="left-panel" style="position: relative;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <lottie-player src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f916/lottie.json"
                    background="transparent" speed="1" style="width: 80px; height: 80px" direction="1" playMode="normal"
                    loop autoplay></lottie-player>
                <div>
                    <h2 class="section-title" style="margin-bottom: 5px;">Upload & Customize</h2>
                    <p style="font-size: 12px; color: var(--text-muted); font-weight: 500;">Hi! I'm your AI stylist.
                        Let's get started.</p>
                </div>
            </div>

            <div class="control-group">
                <label>1. Your Photo</label>
                <div class="photo-options" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button onclick="useProfilePhoto()" class="secondary-btn"
                        style="flex: 1; padding: 10px; font-size: 14px;" title="Load from Profile">üë§ Default
                        Image</button>
                    <button onclick="document.getElementById('user-image').click()" class="secondary-btn"
                        style="flex: 1; padding: 10px; font-size: 14px;">üìÅ Device Upload</button>
                    <button onclick="startWebcam()" class="secondary-btn"
                        style="flex: 1; padding: 10px; font-size: 14px;">üì∑ Webcam</button>
                </div>
                <input type="file" id="user-image" accept="image/*" style="display: none;" />
                <img id="preview" style="display:none; max-width:100%; border-radius:8px; margin-top:10px;"
                    alt="Preview" />
                <video id="webcam" autoplay
                    style="display:none; margin-top: 12px; border-radius: 8px; max-width: 100%;"></video>
                <button id="capture-btn" onclick="capturePhoto()" style="display:none; margin-top: 8px;"
                    class="secondary-btn">üì∏ Capture</button>
                <canvas id="webcam-canvas" style="display:none;"></canvas>
            </div>

            <hr class="divider" />

            <div class="control-group">
                <label>2. Choose Clothing & Category</label>
                <select id="garment-category"
                    style="width: 100%; margin-bottom: 10px; padding: 10px; font-size: 14px; border-radius: 8px; border: 1px solid var(--border); background-color: var(--bg-card); color: var(--text);">
                    <option value="upper_body" selected>Upper Body (Shirts, Tops)</option>
                    <option value="lower_body">Lower Body (Pants, Trousers, Skirts)</option>
                    <option value="dresses">Dresses (Full Body)</option>
                </select>
                <div id="cloth_section" class="cloth-grid" style="grid-template-columns: 1fr;">
                    <button onclick="document.getElementById('outfit-upload').click()" class="cloth-btn"
                        style="padding: 15px; font-size: 16px;">üëï
                        Upload Trial Outfit</button>
                    <input type="file" id="outfit-upload" accept="image/*" style="display:none">
                </div>
            </div>

            <hr class="divider" />

            <div class="control-group" style="display:none;">
                <label>‚öôÔ∏è Backend Config</label>
                <input type="text" id="api-url" placeholder="Paste Colab/Ngrok URL here..."
                    onchange="updateApiUrl(this.value)" />
                <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">Example:
                    https://xxxx.ngrok-free.app</small>
            </div>

            <button id="ai-tryon-btn" onclick="triggerApiTryon()" class="primary-btn hero-btn">
                ‚ú® GENERATE TRY-ON
            </button>

            <section id="accessories-section">
                <h3>3. Try Accessories</h3>
                <div class="cloth-grid" style="grid-template-columns: 1fr;">
                    <button
                        onclick="Swal.fire({icon: 'info', title: 'Coming Soon! üíé', text: 'The AI Accessory Try-On feature is currently under active development. Stay tuned for a glittering update!', confirmButtonColor: '#a855f7', confirmButtonText: 'Got it!'})"
                        class="cloth-btn" style="padding: 15px; font-size: 16px;">üíé
                        Upload Accessory</button>
                    <input type="file" id="accessory-upload" accept="image/*" style="display:none">
                </div>
                <small style="display:block; margin-top:10px; color:var(--text-muted); text-align:center;">Virtually
                    apply accessories using AI.</small>
            </section>
        </div>

        <div class="right-panel">
            <h2 class="section-title">Virtual Result</h2>
            <div id="tryon-result" class="result-box"
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 400px; overflow: hidden;">
                <div class="hologram-container">
                    <div class="hologram-avatar" title="3D Fashion Guide"></div>
                    <div class="hologram-scanner"></div>
                </div>
                <div class="placeholder-text"
                    style="position: absolute; bottom: 30px; background: rgba(0,0,0,0.4); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(4px); color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 10;">
                    ‚ú® Virtual result will appear here</div>
            </div>

            <div class="action-buttons">
                <button onclick="saveAsImage()" class="action-btn">üíæ Save Image</button>
                <button onclick="saveToWardrobe()" class="action-btn">‚ù§Ô∏è Save to Wardrobe</button>
            </div>

            <hr class="divider" />

            <div class="extra-features">


                <div class="feature-block">
                    <h3>AI Stylist</h3>
                    <button onclick="generateRecommendation()" class="outline-btn">üîç Get Suggestion</button>
                    <div id="recommendation" style="display:none;">
                        <p id="rec-text"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HF Token Modal (hidden by default) -->
    <div id="hf-modal-overlay" class="hf-modal-overlay" style="display:none;">
        <div class="hf-modal-card">
            <div class="hf-modal-icon">üîë</div>
            <h2>HuggingFace Token Required</h2>
            <p class="hf-modal-desc">
                The server's AI quota has been exceeded. Please enter your own
                <a href="https://huggingface.co/settings/tokens" target="_blank" rel="noopener">HuggingFace token</a>
                to continue.
            </p>
            <div id="hf-modal-error" class="hf-modal-error" style="display:none;"></div>
            <div class="hf-modal-input-group">
                <input type="password" id="hf-token-input" placeholder="hf_xxxxxxxxxxxxxxxx" autocomplete="off"
                    spellcheck="false" />
                <button type="button" id="hf-token-toggle" class="hf-toggle-btn" title="Show/hide token">üëÅÔ∏è</button>
            </div>
            <div class="hf-modal-actions">
                <button id="hf-token-submit" class="primary-btn" style="flex:1;">Use Token & Retry</button>
                <button id="hf-token-cancel" class="secondary-btn" style="flex:0 0 auto;">Cancel</button>
            </div>
            <p class="hf-modal-hint">Token is stored only in your browser session and never saved on the server.</p>
        </div>
    </div>

    <div id="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner"
                style="border: 3px solid rgba(71,85,105,0.4); border-radius: 50%; border-top: 3px solid #a855f7; width: 48px; height: 48px; animation: spin 0.8s linear infinite; margin: 0 auto 16px;">
            </div>
            <p class="loading-text" style="color: #cbd5e1; font-weight: 600;">Processing...</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Auto-fill API URL when served from same origin -->
    <script>
        (function () {
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                var stored = localStorage.getItem('api_url');
                if (!stored) {
                    var origin = window.location.origin;
                    localStorage.setItem('api_url', origin);
                    var input = document.getElementById('api-url');
                    if (input) input.value = origin;
                }
            }
        })();
    </script>
    <script type="module" src="js/tryon.js?v=639072938267657059"></script>
    <script src="js/network-status.js"></script>
</body>

</html>